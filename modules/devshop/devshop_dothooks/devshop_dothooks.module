<?php

require_once 'vendor/autoload.php';
use Symfony\Component\Yaml\Parser;
use Symfony\Component\Process\Process;
use Symfony\Component\Process\Exception\ProcessFailedException;

/**
 * Implements hook_nodeapi_site_load()
 *
 * For site nodes, look for a .hooks file in the git repo root.
 */
function devshop_dothooks_devshop_environment_alter(&$environment) {
    $yaml = new Parser();
    $hooks_path = $environment->repo_root . '/.hooks';
    $environment->dothooks = $yaml->parse(file_get_contents($hooks_path));
}


/**
 * Implementation of hook_post_hosting_TASK_TYPE_task()
 *
 * Acts after the successful verification of platforms.
 * This is where the sites get automatically created.
 */
function devshop_dothooks_post_hosting_verify_task($task, $data) {

  // Run the "verify" hook from .hooks
  if (!empty($task->ref->environment->dothooks['verify'])) {

    drush_log('[.hooks] Verify hook found.  Running hook...', 'ok');
    drush_log('[.hooks] ' . $task->ref->environment->dothooks['verify'], 'ok');

    $process = new Process($task->ref->environment->dothooks['verify']);
    $process->run(function ($type, $buffer) {
      if (Process::ERR === $type) {
        drush_log($buffer, 'error');
      } else {
        drush_log($buffer, 'ok');
      }
    });

  }
}